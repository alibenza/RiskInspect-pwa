import React,{useState}from'react';import{useInspectionStore}from'../hooks/useInspectionStore';import{generateAnalysisPrompt}from'../utils/aiAnalysis';import { exportToPdf } from './ExportPDF.js';import{BrainCircuit,Sparkles,Loader2,AlertCircle,RefreshCw,FileDown,ShieldCheck}from'lucide-react';const AIAnalysis=()=>{const{responses,questionsConfig,selectedGaranties}=useInspectionStore();const[analysis,setAnalysis]=useState("");const[loading,setLoading]=useState(false);const[error,setError]=useState(null);const runAnalysis=async()=>{if(Object.keys(responses).length===0){setError("Veuillez remplir l'audit d'abord.");return}setLoading(true);setError(null);try{const r=await fetch("https://api.mistral.ai/v1/chat/completions",{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer 3iLUdJmbLlNrXdjgUflUzZWx1HQUoxYx'},body:JSON.stringify({model:"mistral-small-latest",messages:[{role:"system",content:"Expert assurance IARD. Analyse technique rigoureuse."},{role:"user",content:generateAnalysisPrompt(responses,questionsConfig,selectedGaranties)}],temperature:0.2})});const d=await r.json();if(!r.ok)throw new Error(d.message||"Erreur API");if(d.choices)setAnalysis(d.choices[0].message.content)}catch(e){setError(e.message)}finally{setLoading(false)}};return(<div className="space-y-6 pb-28 animate-in fade-in"><div className="bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-xl border border-white/5"><div className="flex items-center space-x-3 mb-2"><BrainCircuit size={24} className="text-indigo-400"/><h2 className="text-xl font-black uppercase">Intelligence Risque</h2></div><p className="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Mistral AI Expert</p></div>{error&&(<div className="bg-red-50 p-4 rounded-2xl flex items-center space-x-3 text-red-600 text-xs font-bold"><AlertCircle size={20}/><span>{error}</span><button onClick={runAnalysis} className="ml-auto"><RefreshCw size={14}/></button></div>)}{!analysis&&!loading?(<button onClick={runAnalysis} className="w-full py-16 border-2 border-dashed border-slate-200 rounded-[3rem] flex flex-col items-center justify-center space-y-4 bg-white hover:bg-slate-50"><Sparkles className="text-indigo-600" size={30}/><span className="font-black text-slate-900 text-sm uppercase">Générer le rapport IA</span></button>):loading?(<div className="bg-white p-20 rounded-[3rem] flex flex-col items-center justify-center space-y-4 border border-slate-50"><Loader2 className="animate-spin text-indigo-600" size={40}/><p className="font-black text-[10px] uppercase">Analyse en cours...</p></div>):(<div className="space-y-4 animate-in slide-in-from-bottom-8"><div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100"><div className="flex items-center space-x-2 mb-6 text-slate-400"><ShieldCheck className="text-green-500" size={18}/><span className="text-[10px] font-black uppercase">Conclusions de l'expert</span></div><div className="prose prose-slate text-sm leading-relaxed text-slate-700 whitespace-pre-wrap">{analysis}</div></div><button onClick={()=>exportToPdf(responses,questionsConfig,analysis)} className="w-full py-5 bg-indigo-600 text-white rounded-2xl flex items-center justify-center space-x-3 shadow-lg"><FileDown size={20}/><span className="font-black text-xs uppercase">Exporter le Rapport PDF</span></button><button onClick={()=>setAnalysis("")} className="w-full text-slate-400 text-[10px] font-black uppercase">Recommencer</button></div>)}</div>)};export default AIAnalysis;
